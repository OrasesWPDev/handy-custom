# CLAUDE.md

Essential development guidance for Claude Code when working with this WordPress plugin.

## Core Architecture & System Overview

- **Plugin Structure**: Modular design with main controller `Handy_Custom` and specialized modules for Products and Recipes
- **Template System**: Dual template system - shortcode templates for archives + single post templates for individual items
- **Asset Management**: Conditional loading - assets only enqueue when relevant shortcodes detected or on single post pages
- **URL System**: Custom URL rewriting for SEO-friendly structures `/products/{category}/{product-slug}/` and `/recipe/{recipe-slug}/`

## Critical Development Notes

### Version Management
- **Always update ALL three version references simultaneously**:
  - `handy-custom.php` header: `* Version: X.X.X`
  - `HANDY_CUSTOM_VERSION` constant: `define('HANDY_CUSTOM_VERSION', 'X.X.X');`
  - `Handy_Custom::VERSION` constant: `const VERSION = 'X.X.X';`
- **Version must exactly match GitHub release tag** for auto-updater to function
- **Update version before creating GitHub releases**

### Template Loading System
- **Single Product Templates**: Loaded via `load_single_product_template()` filter on `single_template` hook
- **Single Recipe Templates**: Loaded via `load_single_recipe_template()` filter on `single_template` hook
- **Shortcode Templates**: Located in `/templates/shortcodes/{type}/archive.php`
- **Asset Loading**: Product/recipe single page assets load via `enqueue_post_type_assets()` method

### URL Structure & Rewrite Rules
- **Product URLs**: `/products/{category}/{product-slug}/` - handled by `handle_product_urls()` method
- **Recipe URLs**: `/recipe/{recipe-slug}/` - standard WordPress structure
- **Dual URL System**: 
  - Incoming URLs processed by rewrite rules in `handle_product_urls()`
  - Outgoing URLs generated by `custom_product_permalink()` filter
- **Category Logic**: Primary top-level category (parent=0) used for URL generation; falls back to first assigned category

### Breadcrumb Integration
- **Yoast SEO Integration**: `modify_yoast_breadcrumbs()` handles both products and recipes
- **Product Breadcrumbs**: `Home / Products / Category / Sub Category / Product Title`
- **Recipe Breadcrumbs**: `Home / Recipes / Recipe Title` 
- **URL Matching**: Breadcrumb structure matches URL hierarchy for SEO consistency

### Filter System Architecture
- **Unified Renderer**: `Handy_Custom_Filters_Renderer` class handles both `[filter-products]` and `[filter-recipes]`
- **Conditional Asset Loading**: Filter CSS/JS only load when filter shortcodes detected on page
- **Template Location**: Filter HTML in `/templates/shortcodes/filters/archive.php`
- **AJAX Handling**: Filters communicate via URL parameters and AJAX endpoints

### Auto-Updater Implementation
- **Library**: Uses YahnisElsts Plugin Update Checker v5.6 (industry standard)
- **Integration**: `Handy_Custom_Simple_Updater` class, initialized only in admin context
- **Update Detection**: 1-minute check period (`setCheckPeriod(1/60)`) for rapid deployment
- **GitHub Integration**: Direct repository monitoring without external dependencies

### Database & Caching
- **Database Access**: READ ONLY SQL queries - never modify data through direct SQL
- **Caching System**: Two-tier caching (WordPress object cache + static cache) via `Base_Utils`
- **Cache Invalidation**: Comprehensive cache busting on term/post changes
- **Performance**: Conditional caching skipped for large result sets (>200 posts)

### Debug System
- **Debug Flag**: `HANDY_CUSTOM_DEBUG` constant controls logging throughout plugin
- **Filter JS**: Respects debug flag for console logging in filter functionality
- **Logging Location**: `/logs/` directory (automatically secured)
- **Log Coverage**: Comprehensive logging for URL handling, breadcrumbs, caching, and AJAX operations

### Post Type & Taxonomy Requirements
- **Post Types**: `product`, `recipe` - must exist for plugin functionality
- **Product Taxonomies**: `product-category` (hierarchical), `grade`, `market-segment`, `product-cooking-method`, etc.
- **Recipe Taxonomies**: `recipe-category`, `recipe-cooking-method`, etc.
- **ACF Integration**: Extensive ACF field usage for metadata - ACF must be active

### Security Considerations
- **AJAX Nonces**: All AJAX requests use WordPress nonce verification
- **URL Validation**: Internal URL validation for ACF fields (must start with `/products/`)
- **Capability Checks**: Admin functionality requires appropriate WordPress capabilities
- **Sanitization**: All user inputs sanitized using WordPress sanitization functions

### Template Override System
- **Theme Override Path**: `/wp-content/themes/your-theme/handy-custom/`
- **Template Hierarchy**: Plugin templates can be overridden by placing in theme directory
- **Template Types**: Single templates (`product/single.php`, `recipe/single.php`) and archive templates

### Performance Optimization Notes
- **Conditional Loading**: No assets loaded unless shortcodes present or on single posts
- **Query Optimization**: Efficient database queries with proper WP_Query usage
- **Pagination**: Built-in pagination support with safety limits (max 100 per page)
- **Cache Management**: Intelligent cache invalidation prevents stale data

### File Structure Key Locations
```
/includes/
  ├── class-handy-custom.php           # Main controller
  ├── class-base-utils.php             # Shared utilities & caching
  ├── class-shortcodes.php             # Shortcode handlers
  ├── products/                        # Product module
  └── recipes/                         # Recipe module
/templates/
  ├── product/single.php               # Single product template
  ├── recipe/single.php                # Single recipe template
  └── shortcodes/                      # Archive templates
/assets/
  ├── css/products/single-product.css  # Single product styles
  ├── css/recipes/single-recipe.css    # Single recipe styles
  └── js/                              # JavaScript files
```

### Common Development Tasks
- **Adding New Fields**: Update ACF integration in display classes and templates
- **Modifying Templates**: Edit in `/templates/` or override in theme
- **URL Structure Changes**: Modify rewrite rules in main class and regenerate permalinks
- **New Taxonomies**: Add to taxonomy mapping in utils classes
- **Cache Clearing**: Use `Handy_Custom_Base_Utils::clear_all_caches()` for nuclear option

### Browser Testing System (Playwright + Local by WP Engine)
- **Local-First Testing**: Complete testing setup using Local by WP Engine at localhost:10008
- **Automated Deployment**: `npm run deploy:local` copies plugin from dev to Local test site
- **File Watcher**: `npm run watch:deploy` auto-deploys on changes during development
- **Version Management**: `npm run version:update -- --increment patch` updates all 3 version locations
- **Database Management**: `npm run db:reset` for backup/restore of test database states
- **Test Categories**: Smoke tests (`@smoke`) for basic validation, Full tests (`@full`) for comprehensive coverage
- **Cross-Browser**: Playwright tests on Chrome, Firefox, Safari
- **WordPress Utils**: `WordPressUtils` class for login, plugin management, common WordPress tasks
- **Plugin Utils**: `PluginUtils` class for testing shortcodes, filters, single pages, URL rewriting

### Development Workflow with Testing
1. **Development Phase**: Use `npm run watch:deploy` for auto-deployment on file changes
2. **Testing Phase**: Run `npm run test:smoke` for quick validation, `npm run test:full` for comprehensive tests
3. **Pre-Release**: `npm run version:update`, `npm run test:full`, manual validation on localhost:10008
4. **Release**: Create GitHub PR only after all local tests pass

### Testing File Structure
```
/tests/
├── e2e/                     # End-to-end test files
│   ├── smoke.spec.js        # Basic smoke tests (@smoke)
│   ├── products.spec.js     # Product functionality tests (@full)
│   └── recipes.spec.js      # Recipe functionality tests (@full)
├── helpers/                 # Testing utilities
│   ├── wordpress-utils.js   # WordPress-specific helpers
│   └── plugin-utils.js      # Plugin-specific helpers
└── data/                    # Test data and database backups
/scripts/                    # Automation scripts
├── deploy-to-local.js       # Deploy plugin to Local site
├── watch-and-deploy.js      # Auto-deploy on file changes
├── update-version.js        # Update plugin version
└── reset-test-db.js         # Database management
```

### Testing Commands for Development
- `npm run test:smoke` - Quick smoke tests for basic validation
- `npm run test:full` - Comprehensive test suite
- `npm run test:headed` - Run tests with visible browser for debugging
- `npm run deploy:local` - Manual deployment to Local test site
- `npm run watch:deploy` - Auto-deploy on file changes
- `npm run version:update -- --increment patch` - Auto-increment version
- `npm run db:reset backup --name "clean-state"` - Create database backup
- `npm run db:reset restore --source "clean-state"` - Restore from backup

### Critical Testing Notes
- **Always test locally first** before creating GitHub PRs
- **Version updates MUST be tested** with full test suite before release
- **Database backups** should be created before major changes
- **Local by WP Engine** must be running with handy-crab site at localhost:10008
- **No GitHub integration** - all testing happens locally until manual PR creation